#!/bin/bash

# Claude Warp - Fast model switching for Claude Code
# Quick switch when you run out of quota

VERSION="0.2.0"

set -e

SETTINGS_FILE="$HOME/.claude/settings.json"
PORT=8080

# Colors (fallback if gum not available)
R='\033[0;31m'
G='\033[0;32m'
Y='\033[1;33m'
C='\033[0;36m'
N='\033[0m'

# Clean exit on Ctrl+C
trap 'echo ""; exit 0' INT TERM

# Check if proxy is running
is_proxy_running() {
    lsof -i :$PORT &>/dev/null
}

# Ensure settings file exists
ensure_settings() {
    mkdir -p "$(dirname "$SETTINGS_FILE")"
    [[ -f "$SETTINGS_FILE" ]] || echo '{}' > "$SETTINGS_FILE"
}

# Get current model (returns string)
get_model() {
    if [[ ! -f "$SETTINGS_FILE" ]]; then
        echo "Native Claude API"
        return
    fi

    local url=$(jq -r '.env.ANTHROPIC_BASE_URL // empty' "$SETTINGS_FILE" 2>/dev/null)
    local model=$(jq -r '.env.ANTHROPIC_MODEL // empty' "$SETTINGS_FILE" 2>/dev/null)

    if [[ -z "$url" || "$url" == "null" ]]; then
        echo "Native Claude API"
    else
        echo "$model"
    fi
}

# Show status
status() {
    local model=$(get_model)
    local proxy_status

    if is_proxy_running; then
        proxy_status="● running"
    else
        proxy_status="○ stopped"
    fi

    gum style --foreground 212 "Model: $model"
    if is_proxy_running; then
        gum style --foreground 114 "Proxy: $proxy_status (port $PORT)"
    else
        gum style --foreground 203 "Proxy: $proxy_status (port $PORT)"
    fi
}

# Start proxy
start_proxy() {
    if is_proxy_running; then
        gum style --foreground 214 "Proxy already running on :$PORT"
        return 0
    fi
    gum style --foreground 117 "Starting proxy on :$PORT..."
    if command -v osascript &>/dev/null; then
        osascript -e "tell application \"Terminal\" to do script \"npx antigravity-claude-proxy start --port $PORT\""
        gum style --foreground 114 "✓ Proxy started in new Terminal"
    else
        nohup npx antigravity-claude-proxy start --port $PORT > /tmp/claude-warp-proxy.log 2>&1 &
        gum style --foreground 114 "✓ Proxy started (log: /tmp/claude-warp-proxy.log)"
    fi
}

# Stop proxy
stop_proxy() {
    if is_proxy_running; then
        kill $(lsof -t -i :$PORT) 2>/dev/null
        gum style --foreground 114 "✓ Proxy stopped"
    else
        gum style --foreground 214 "No proxy running on :$PORT"
    fi
}

# Switch to native
switch_native() {
    ensure_settings
    local tmp=$(jq 'del(.env.ANTHROPIC_BASE_URL, .env.ANTHROPIC_AUTH_TOKEN, .env.ANTHROPIC_MODEL) |
                    if .env == {} then del(.env) else . end' "$SETTINGS_FILE")
    echo "$tmp" > "$SETTINGS_FILE"
    gum style --foreground 114 "✓ Switched to Native Claude API"

    # Ask to stop proxy if running
    if is_proxy_running; then
        if gum confirm "Stop proxy server?"; then
            stop_proxy
        fi
    fi
}

# Switch to proxy model
switch_proxy() {
    local model=$1

    # Check if proxy is running
    if ! is_proxy_running; then
        gum style --foreground 214 "Proxy not running"
        if gum confirm "Start proxy server?"; then
            start_proxy
            sleep 1
        else
            gum style --foreground 203 "Aborted. Proxy required for this model."
            return 1
        fi
    fi

    ensure_settings
    local tmp=$(jq --arg m "$model" --arg p "$PORT" '
        .env.ANTHROPIC_AUTH_TOKEN = "test" |
        .env.ANTHROPIC_BASE_URL = "http://localhost:\($p)" |
        .env.ANTHROPIC_MODEL = $m
    ' "$SETTINGS_FILE")
    echo "$tmp" > "$SETTINGS_FILE"
    gum style --foreground 114 "✓ Switched to $model"
}

# Interactive menu
menu() {
    echo ""
    gum style --border double --padding "0 1" --border-foreground 212 "Claude Warp"
    echo ""
    status
    echo ""

    local choice=$(gum choose \
        "sonnet      → Claude Sonnet 4.5 (thinking)" \
        "opus        → Claude Opus 4.5 (thinking)" \
        "claude      → Claude Sonnet 4.5 (no thinking)" \
        "gemini      → Gemini 3 Flash" \
        "gemini-pro  → Gemini 3 Pro (high)" \
        "native      → Native Claude API" \
        "accounts    → Manage Google accounts" \
        "proxy       → Start/Stop proxy server" \
        "quit")

    case "$choice" in
        sonnet*)      switch_proxy "claude-sonnet-4-5-thinking" ;;
        opus*)        switch_proxy "claude-opus-4-5-thinking" ;;
        claude*)      switch_proxy "claude-sonnet-4-5" ;;
        gemini-pro*)  switch_proxy "gemini-3-pro-high" ;;
        gemini*)      switch_proxy "gemini-3-flash" ;;
        native*)      switch_native ;;
        accounts*)    accounts_menu; menu ;;
        proxy*)       proxy_menu; menu ;;
        quit|"")      exit 0 ;;
    esac
}

# Proxy control menu
proxy_menu() {
    echo ""
    gum style --foreground 117 "Proxy Control"
    if is_proxy_running; then
        gum style --foreground 114 "Status: ● running"
    else
        gum style --foreground 203 "Status: ○ stopped"
    fi
    echo ""

    local choice=$(gum choose "start" "stop" "back")

    case "$choice" in
        start) start_proxy ;;
        stop)  stop_proxy ;;
        back|"") return ;;
    esac
}

# Account management
accounts() {
    case "$1" in
        add|a)    npx antigravity-claude-proxy accounts add ;;
        list|l)   npx antigravity-claude-proxy accounts list ;;
        verify|v) npx antigravity-claude-proxy accounts verify ;;
        limits)   curl -s "http://localhost:$PORT/account-limits?format=table" 2>/dev/null || gum style --foreground 203 "Proxy not running" ;;
        "")       accounts_menu ;;
        *)        npx antigravity-claude-proxy accounts list ;;
    esac
}

# Account management menu
accounts_menu() {
    echo ""
    gum style --foreground 117 "Account Manager"
    echo ""

    local choice=$(gum choose \
        "list    → Show all accounts" \
        "add     → Add new Google account (OAuth)" \
        "verify  → Verify all accounts" \
        "limits  → Check quota limits" \
        "back")

    case "$choice" in
        list*)   echo ""; npx antigravity-claude-proxy accounts list ;;
        add*)    echo ""; npx antigravity-claude-proxy accounts add ;;
        verify*) echo ""; npx antigravity-claude-proxy accounts verify ;;
        limits*) echo ""; accounts limits ;;
        back|"") return ;;
    esac
}

# Help
help() {
    echo "Claude Warp v$VERSION - Fast model switching"
    echo ""
    echo "Usage: claude-warp [command]"
    echo ""
    echo "Switch Models:"
    echo "  s, sonnet     Claude Sonnet 4.5 (thinking)"
    echo "  o, opus       Claude Opus 4.5 (thinking)"
    echo "  c, claude     Claude Sonnet 4.5 (no thinking)"
    echo "  g, gemini     Gemini 3 Flash"
    echo "  gp            Gemini 3 Pro (high)"
    echo "  gl            Gemini 3 Pro (low)"
    echo "  n, native     Native Claude API (restore)"
    echo ""
    echo "Proxy Control:"
    echo "  start         Start proxy server"
    echo "  stop          Stop proxy server"
    echo "  status        Show current status"
    echo ""
    echo "Accounts:"
    echo "  acc           Interactive account manager"
    echo "  acc add       Add new Google account (OAuth)"
    echo "  acc list      List all accounts"
    echo "  acc verify    Verify all accounts"
    echo "  acc limits    Check quota limits"
    echo ""
    echo "No args = interactive menu"
}

# Main
case "${1:-}" in
    "")           menu ;;
    n|native)     switch_native ;;
    s|sonnet)     switch_proxy "claude-sonnet-4-5-thinking" ;;
    o|opus)       switch_proxy "claude-opus-4-5-thinking" ;;
    c|claude)     switch_proxy "claude-sonnet-4-5" ;;
    g|gemini)     switch_proxy "gemini-3-flash" ;;
    gp)           switch_proxy "gemini-3-pro-high" ;;
    gl)           switch_proxy "gemini-3-pro-low" ;;
    start)        start_proxy ;;
    stop)         stop_proxy ;;
    acc|accounts) accounts "$2" ;;
    status)       status ;;
    -v|--version) echo "claude-warp v$VERSION" ;;
    h|help|-h|--help) help ;;
    *)
        gum style --foreground 203 "Unknown: $1"
        help
        exit 1
        ;;
esac
